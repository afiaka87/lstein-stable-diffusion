# Configuration for Cog ⚙️
# Reference: https://github.com/replicate/cog/blob/main/docs/yaml.md
build:
  gpu: true
  cuda: "11.6.2"
  # cuda: "11.3"
  # python_version: "3.8"
  python_version: "3.10"
  system_packages:
    - "libgl1-mesa-glx"
    - "libglib2.0-0"
  python_packages:
    # successfully installed 
    - pynvml==11.4.1
    - PyWavelets==1.3.0 
    - accelerate==0.12.0
    - jsonmerge==1.8.0
    - huggingface-hub==0.8.1
    - imageio-ffmpeg==0.4.2
    - imageio==2.9.0
    - albumentations==0.4.3
    - clean-fid==0.1.29
    - omegaconf==2.1.1
    - einops==0.4.1
    - pyyaml==6.0
    - kornia==0.6.0
    - resize-right==0.0.2
    - pytorch-lightning==1.7.6
    - psutil==5.9.2
    - streamlit==1.12.2
    - scipy==1.9.1
    - torch-fidelity==0.3.0
    - torchmetrics==0.9.3
    - torchdiffeq==0.2.3
    - torch==1.12.1 --extra-index-url=https://download.pytorch.org/whl/cu116
    - torchtext==0.13.1
    - torchvision==0.13.1 --extra-index-url=https://download.pytorch.org/whl/cu116
    - transformers==4.19.2
    - tqdm==4.64.1
    # - wandb
  run:
    # Install code from github
    - mkdir -p /root/.cache/gfpgan/experiments/pretrained_models/ && wget "https://github.com/TencentARC/GFPGAN/releases/download/v1.3.0/GFPGANv1.3.pth" -O "/root/.cache/gfpgan/experiments/pretrained_models/GFPGANv1.3.pth"
    - git clone -b main --single-branch https://github.com/openai/CLIP.git && pip install -e CLIP
    # this works but cant use local updates
    # - git clone -b master --single-branch https://github.com/lstein/k-diffusion.git && pip install --no-deps -e k-diffusion
    - git clone -b master --single-branch https://github.com/CompVis/taming-transformers.git && pip install -e taming-transformers
    - git clone -b fix-dark-cast-images --single-branch https://github.com/lstein/GFPGAN && pip install -e GFPGAN
    - git clone https://github.com/xinntao/Real-ESRGAN && cd Real-ESRGAN && python setup.py develop && cd ..
    # Download models
    - mkdir -p /src && wget https://raw.githubusercontent.com/lstein/stable-diffusion/main/scripts/preload_models.py -O /src/preload_models.py && python /src/preload_models.py
# - mkdir -p /root/.cache/torch/hub/checkpoints/ && wget --output-document "/root/.cache/torch/hub/checkpoints/checkpoint_liberty_with_aug.pth" "https://github.com/DagnyT/hardnet/raw/master/pretrained/train_liberty_with_aug/checkpoint_liberty_with_aug.pth"

predict: "predict.py:Predictor"
